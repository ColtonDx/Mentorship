#!/bin/bash

# Enable IP forwarding
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf

# Apply the changes
sudo sysctl -p

# Setup NAT for internet access via eth0 (assuming eth0 is the interface with 10.0.3.5)
sudo iptables -t nat -A POSTROUTING -s 10.0.1.0/24 -o eth0 -j MASQUERADE
sudo iptables -t nat -A POSTROUTING -s 10.0.2.0/24 -o eth0 -j MASQUERADE

# Allow SSH traffic on eth0 from any source
sudo iptables -A INPUT -i eth0 -p tcp --dport 22 -j ACCEPT

# Allow HTTP traffic on eth0
sudo iptables -A INPUT -i eth0 -p tcp --dport 80 -j ACCEPT

# Allow all outbound traffic
sudo iptables -A OUTPUT -j ACCEPT

# Drop all other incoming traffic on eth0
sudo iptables -A INPUT -i eth0 -j DROP

# Save the iptables rules
sudo mkdir -p /etc/iptables
sudo iptables-save | sudo tee /etc/iptables/rules.v4

# Create a script to restore iptables rules on boot
sudo bash -c 'cat <<EOT > /usr/local/bin/restore-iptables.sh
#!/bin/bash
/sbin/iptables-restore < /etc/iptables/rules.v4
EOT'

# Make the script executable
sudo chmod +x /usr/local/bin/restore-iptables.sh

# Create systemd service to restore iptables rules on boot
sudo bash -c 'cat <<EOT > /etc/systemd/system/iptables-restore.service
[Unit]
Description=Restore iptables rules

[Service]
ExecStart=/usr/local/bin/restore-iptables.sh

[Install]
WantedBy=multi-user.target
EOT'

# Enable the service
sudo systemctl daemon-reload
sudo systemctl enable iptables-restore.service
sudo systemctl start iptables-restore.service

echo "IP forwarding enabled, NAT and port forwarding configured, traffic filtering on eth0 applied, and settings made persistent."
