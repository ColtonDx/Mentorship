#!/bin/bash

# Enable IP forwarding
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf

# Apply the changes
sudo sysctl -p

# Setup port forwarding from public IP to 10.0.1.4 on port 80
sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 10.0.1.4:80
sudo iptables -t nat -A POSTROUTING -p tcp -d 10.0.1.4 --dport 80 -j MASQUERADE

# Save the iptables rules
sudo mkdir -p /etc/iptables
sudo iptables-save | sudo tee /etc/iptables/rules.v4

# Create a script to restore iptables rules on boot
sudo bash -c 'cat <<EOT > /etc/network/if-pre-up.d/iptables.sh
#!/bin/sh
iptables-restore < /etc/iptables/rules.v4
EOT'

# Make the script executable
sudo chmod +x /etc/network/if-pre-up.d/iptables.sh

echo "IP forwarding enabled, port forwarding rules added, and settings made persistent."
